<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link sizes="32x32" rel="icon" type="image/ico" href="ico.ico">
    <title>Shifro</title>
</head>
<body>
    <style>
#auth button,#dataSave #secure,#dataSave .btnGroup .secureLabel,.addbtn,.del,.fileblock,.menu li,.showhide,.showtags,.spoiler,.tag li{cursor:pointer}body,h1{margin:0}.addbtn,.password{border-radius:5px}.menu,.tag{list-style:none}.menu:hover li,.tag li,.tag:hover li{color:#bdbdbd}@font-face{font-family:InterReg;font-style:normal;font-weight:400;src:url('font/inter-regular-webfont.woff2') format('woff2'),url('font/inter-regular-webfont.ttf') format('truetype')}@font-face{font-family:InterMed;font-style:normal;font-weight:400;src:url('font/inter-medium-webfont.woff2') format('woff2'),url('font/inter-medium-webfont.ttf') format('truetype')}@font-face{font-family:InterBold;font-style:normal;font-weight:400;src:url('font/inter-bold-webfont.woff2') format('woff2'),url('font/inter-bold-webfont.ttf') format('truetype')}body{font:14px InterReg,sans-serif}b,h1,h2,h3,h4{font-weight:400;font-family:InterBold,sans-serif}.none{display:none!important}#auth,.ifauth{display:none}.unone{user-select:none}.wrap{width:600px;margin:0 auto}#dataSave,.bottom,.fileblock,.header,.logo,.menu,.tag{display:flex}.logo{align-items:center}.logo svg{width:70px;margin-right:15px}h1{font:72px InterBold;letter-spacing:-.07em}.addbtn{padding:20px 0 20px 20px;font:24px InterReg;margin:13px 0 0}.header{align-items:center;justify-content:space-between;margin:30px 0 10px}#auth{margin:30px 0;justify-content:space-between;gap:20px}.password{width:100%;height:50px;padding:0 0 0 15px;border:1px solid #a3a3a3;font:18px InterReg,sans-serif}#auth button{width:140px;font-size:18px;border:none;border-radius:5px;background:#e3e3e3}.menu{padding:0;margin:0 0 15px;flex-wrap:wrap;gap:15px;font:22px InterReg;pointer-events:none;max-height:95px;overflow:hidden}.bottom,.spoiler{font:18px InterReg}.menu li{pointer-events:auto;padding:20px 0;line-height:0}.menu li:hover,.tag li:hover{color:#000}#dataSave{flex-wrap:wrap;justify-content:space-between;margin:20px 0}#dataSave .btnFile,#dataSave .btnGroup button{box-sizing:border-box;font:18px/50px InterReg;margin-right:15px;cursor:pointer}#dataSave textarea{height:150px;padding:15px;border-radius:5px;border:1px solid #a3a3a3;font:18px InterReg,sans-serif}#dataSave *{width:100%;margin-bottom:15px}#dataSave .btnGroup{display:flex;align-items:center;flex-wrap:wrap}#dataSave #secure{width:20px}#dataSave .btnGroup .secureLabel{font:16px InterReg,sans-serif;padding:15px 0 15px 5px;flex:1}#dataSave .btnGroup button{width:200px;height:50px;border:none;border-radius:5px;background:#e3e3e3}#dataSave input{height:50px;padding:0 0 0 15px;border-radius:5px;border:1px solid #a3a3a3;font:18px InterReg,sans-serif}#dataSave .btnFile{width:85px;border:1px solid #a3a3a3;height:50px;border-radius:5px;text-align:center;display:inline-block}#dataSave .inputFile{width:.1px;height:.1px;opacity:0;overflow:hidden;position:absolute;z-index:-1}.block:hover .del{opacity:1}#wrapContent h3{font:32px InterBold;margin:0 0 25px}.block{margin-bottom:50px}#wrapContent p{font:22px/28px InterReg}.tag{flex-wrap:wrap;grid-gap:20px;margin:0;padding:0}.bottom{align-items:center;justify-content:space-between}.del{opacity:0;transition:opacity .15s}.spoiler{border-bottom:1px solid #333}.showhide{color:#239aff;border-bottom:1px solid #239aff}.progress{height:5px;background:#000;top:-5px;position:fixed;max-width:100%;width:100%;transition:.15s}.imagepreview,.shadow{position:fixed;top:0;bottom:0;right:0;left:0}.fileblock svg{width:25px;margin:0 5px 0 15px}.fileblock{height:65px;margin-bottom:5px;border:1px solid #c4c4c4;align-items:center;text-decoration:none;color:#000;border-radius:10px}.fileblock div{display:block;font:14px InterReg}.fileblock span{display:block;font:12px InterReg;opacity:.6}.imagepreview{max-width:80%;max-height:80%;width:auto;height:auto;margin:auto;z-index:5}.shadow{background:rgb(0 0 0 / 60%);width:100%;height:100%;z-index:1}.showtags{font-size:24px;color:#239aff;border-bottom:1px solid #239aff}#wrapContent{margin-top:50px}@media (max-width:620px){#dataSave .btnGroup button,#dataSave input,#dataSave textarea{border-radius:2vw;font-size:5.5vw}.wrap{width:90vw}.header{margin:5vw 0 3vw}h1{font-size:15vw}.addbtn{margin:0;font-size:6vw;padding:5vw 0 5vw 5vw}.bottom,.menu,.spoiler{font-size:4.5vw}.dataSave{margin:5vw 0 0}#dataSave input{height:14vw;padding:0 0 0 4vw}#dataSave *{margin-bottom:3vw}#dataSave textarea{height:30vw;padding:4vw}#dataSave .btnGroup button{order:4;width:100%;margin-right:0;height:15vw;line-height:normal}#dataSave .btnFile{order:3;width:40vw;margin:0;height:15vw;line-height:15vw;font-size:6vw}#dataSave .btnGroup{justify-content:space-between;align-items:stretch}#dataSave #secure{order:1;width:7vw;padding:3vw;margin:1vw 0 0 4vw}#dataSave .btnGroup .secureLabel{order:2;width:35vw;display:block;flex:none;padding:2vw 0 2vw 2vw;font-size:4.5vw}.menu li{pointer-events:auto;padding:6vw 0}.menu{column-gap:6vw;padding:0;row-gap:0;max-height:24vw;overflow:hidden;margin:0 0 3vw}#wrapContent{margin-top:10vw}.block{margin-bottom:10vw}#wrapContent h3{font-size:6.5vw;margin:0 0 5vw}#wrapContent p{margin:0 0 5vw;font:6vw/8vw InterReg}.fileblock{height:20vw;margin-bottom:2vw;border-radius:3vw}#auth button,.password{height:15vw;border-radius:2vw}.fileblock svg{width:6vw;margin:0 2vw 0 4vw}.fileblock div{font-size:4.5vw}.fileblock span{font-size:4vw}#auth button,.password,.showtags{font-size:6vw}.password{padding:0 0 0 4vw;margin-bottom:3vw}#auth button{width:100%}#auth{display:flex;gap:0;flex-wrap:wrap}}
  </style>
  <div class="progress"><div class="progresstext"></div><div class="progressline"></div></div>
  <div class="wrap">
    <div class="header">
     <div class="logo">
       <h1 class="unone">Shifro</h1>
     </div>      
      <div class="addbtn unone ifauth">добавить +</div>
    </div>
    <form id="auth">
        <input type="password" class="password" name="password" placeholder="пароль" readonly
    onfocus="this.removeAttribute('readonly')"><button class="unone">войти</button>
    </form>
    <form id="dataSave" class="none dataSave">
      <input type="text" id="title" name="title" placeholder="заголовок" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
      <textarea id="content" name="content" placeholder="текст
#тег #тег2"></textarea>
            <div class="btnGroup">
                <button type="submit" class="unone">сохранить</button>
                <label for="inputFile" class="btnFile unone">файл</label>
                <input type="file" class="inputFile" id="inputFile" name="file" multiple onchange="inputJs(this)">
                <input type="checkbox" name="secure" id="secure">
                <label for="secure" class="unone secureLabel">скрытые данные</label>
            </div>
        </form>
    <div class="ifauth wrapcont">
        <ul class="menu unone" onclick="handleTag(event)">
            <li>всё</li>
        </ul>
        <div id="wrapContent"></div>
    </div>
  </div>
</body>
</html>
<script>
const user="shifro",rep="shifro",giturl="https://api.github.com/repos/shifro/shifro/contents/",dbfile="database.txt",dburl=giturl+"database.txt";let password,encryptdb,jsonara,token,sha,id,maxfilesize=0,wc=q(".console .wrap");function cl(t){console.log(t)}function formatValue(t){if("string"==typeof t){if(t.length>100)return t.slice(0,100)+"..."}else if(Array.isArray(t))return t.map(formatValue);else if("object"==typeof t){let a={};for(let n in t)a[n]=formatValue(t[n]);return a}return t}function q(t){return document.querySelector(t)}function qq(t){return document.querySelectorAll(t)}function escapeHTML(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>")}function formatFileSize(t){return t>=1048576?(t/1048576).toFixed(2)+" мб":t>=1024?(t/1024).toFixed(2)+" кб":t+" байт"}function wrapLinksInAnchorTags(t){return t.replace(/\S+\.\S+/g,t=>`<a href="//${t}" target="_blank">${t}</a>`)}function inputJs(t){""!=t.value?t.previousElementSibling.innerHTML=`+ ${t.files.length}`:t.previousElementSibling.innerHTML="файл",t.files}async function getFile(t,a){let n=jsonara.data[t],s=[],i=await req("GET",n.files[a].url,n.files[a].size),r=JSON.parse(atob(i.content));for(var l=0;l<r.length;l++){let o=await decrypt(r[l]);s.push(o)}let c=s.join("");n.files[a].type.includes("image")?q("body").insertAdjacentHTML("afterbegin",`<div class="shadow" onclick="this.remove();"><img src="${c}" class="imagepreview"></div>`):base2file(n.files[a].name,s.join(""))}function viewContent(t,a=1){let n=jsonara.data.length;t.forEach(function(t,s){if(t){let i=viewfile="";t.files&&t.files.length>0&&t.files.forEach(function(t,a){viewfile+=`<div class="fileblock" onclick="getFile(${n-s-1},${a})"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><defs><style>.a{fill:none;stroke:#000000;stroke-linecap:round;stroke-linejoin:round;}</style></defs><path class="a" d="M39.5,15.5h-9a2,2,0,0,1-2-2v-9h-18a2,2,0,0,0-2,2v35a2,2,0,0,0,2,2h27a2,2,0,0,0,2-2Z"></path><line class="a" x1="28.5" y1="4.5" x2="39.5" y2="15.5"></line></svg><div>${t.name}<span>${formatFileSize(t.size)}</span></div></div>`}),t.tags.length>0&&t.tags.forEach(function(t){i+=`<li>${t}</li>`});let r=`<div class="block" id="rec${n-s-1}"><h3>${t.title}</h3><p>${t.content.length>300?t.content.substring(0,300)+"... <span class='showhide unone' onclick='spoilerBlock(this)'>показать запись</span>":t.hasOwnProperty("secure")?"<span class='showhide unone' onclick='spoilerBlock(this)'> показать запись</span>":t.content}</p>${viewfile}<div class="bottom"><ul class="tag unone" onclick="handleTag(event)">${i}</ul><span class="del unone" onclick="removeBlock(this)">удалить</span></div></div>`;whereinsert=1===a?"beforeend":"afterbegin",q("#wrapContent").insertAdjacentHTML(whereinsert,r)}})}function req(t,a,n=!1){return cl({"Отправка запроса":{e:t,t:a,n}}),new Promise(function(s,i){var r=new XMLHttpRequest;r.open(t,a,!0),token&&r.setRequestHeader("Authorization",`token ${token}`),r.setRequestHeader("Content-Type","application/json"),r.upload.onprogress=function(t){loadanim(t.loaded/t.total*100)},"GET"===t&&n&&(r.onprogress=t=>{cl("Получение данных"),loadanim(t.loaded/n*73)}),r.onload=()=>{cl({"API запрос выполнен":JSON.parse(r.response)}),loadanim(),r.status>=200&&r.status<300?s(JSON.parse(r.response)):i(r.status)},r.onerror=function(){i(r.statusText),loadanim()},"PUT"===t||"DELETE"===t?(r.setRequestHeader("Content-Type","application/json;charset=UTF-8"),r.send(JSON.stringify(n))):r.send()})}function readFileAsync(t){return new Promise(a=>{let n=new FileReader;n.readAsDataURL(t),n.onload=function(){a({name:t.name,type:t.type,size:t.size,data:n.result})}})}async function cryptoFiles(t){try{let a=[],n=await limitCryptoApi(maxfilesize),s=n;cl(`Всего файлов ${t.length}`);for(let i=0;i<t.length;i++){let r=[],l=0;cl(`Чтение файла: ${i+1}`);let o=await readFileAsync(t[i]);for(cl(`Шифрование файла`);l<o.data.length;){let c=await encrypt(o.data.slice(l,l+s));r.push(c),l+=s,loadanim(l/o.data.length*100)}loadanim(),cl(`Файл зашифрован`);let d=await updategit(JSON.stringify(r),`${id}_${i}.shfro`);cl({"Файл отправлен":d}),a.push({name:o.name,type:o.type,size:o.size,sha:d.content.sha,url:d.content.git_url})}return cl(`Все файлы обработаны`),a}catch(h){throw cl({"Catch в cryptoFiles":h}),h}}async function updategit(t,a="db"){try{let n={message:"shifro",content:btoa(unescape(encodeURIComponent(t))),sha:sha};url="db"===a?dburl:`${giturl}files/${a}`;let s=await req("PUT",url,n);return"db"===a&&(sha=s.content.sha),s}catch(i){throw cl({"Catch в updategit":i}),t}}async function removeBlock(t){cl("Удаление записи");let a=t.closest(".block").id,n=Number(a.replace(/\D+/g,"")),s=[],i=jsonara.data[n].tags;if(jsonara.data[n].files)for(var r=0;r<jsonara.data[n].files.length;r++)await req("DELETE",`${giturl}files/${n}_${r}.shfro`,{message:"shifro",sha:jsonara.data[n].files[r].sha});for(let l of i)jsonara.tags[l]=jsonara.tags[l].filter(t=>t!==n),0===jsonara.tags[l].length&&(s.push(l),delete jsonara.tags[l]);delete jsonara.data[n];let o=await encrypt(JSON.stringify(jsonara));updategit(o).then(t=>{q("#"+a).remove(),s.length>0&&q(".menu").querySelectorAll("li").forEach(t=>{s.includes(t.textContent)&&t.remove()})}).catch(t=>{cl({"Catch в removeblock":t}),alert(`ошибка при удалении объекта: ${t}`)}),cl("запись удалена")}function handleTag(t){"LI"===t.target.nodeName&&(targetTag=t.target.innerText,q("#wrapContent").innerHTML="","всё"===targetTag?(jsonara.data.reverse(),viewContent(jsonara.data),jsonara.data.reverse()):viewContent((newArray=jsonara.tags[targetTag].map(t=>jsonara.data[t])).reverse()))}function spoilerBlock(t,a=!0){let n=t.closest(".block"),s=Number(n.id.replace(/\D+/g,""));n.querySelector("p").innerHTML=!0===a?jsonara.data[s].content+"<br><span class='showhide unone' onclick='spoilerBlock(this, false)'>скрыть запись</span>":"<span class='showhide unone' onclick='spoilerBlock(this)'>показать запись</span>"}document.addEventListener("DOMContentLoaded",async()=>{try{let t=await req("GET",dburl+"?r="+Math.random());if(t.content.length>0||(t=await req("GET",t.git_url,t.size)),t.content)encryptdb=atob(t.content),sha=t.sha,q("#auth").style.display="flex";else throw"Контента нет"}catch(a){cl({"catch DOMContentLoaded":a}),alert(`Не удалось получить БД. Ошибка ${e}`)}}),q("#dataSave").addEventListener("submit",async function(t){t.preventDefault();let a=document.getElementById("inputFile");inputJs(a);try{let n={};id=jsonara.data.length,timestamp=(new Date).toLocaleString(),n.time=timestamp;let s=new FormData(this);for(let[i,r]of s.entries())"file"!==i?n[i]=r:maxfilesize=r.size>maxfilesize?r.size:maxfilesize;if(n.title.length<1)throw"укажи заголовок";if(n.content.length<1)throw"укажи данные";let l=/#[^\s#]+/g,o=n.content.match(l),c=[];if(o){for(var d=0;d<o.length;d++){var h=o[d].substring(1);c.push(h)}n.tags=c}else n.tags=["безтега"];n.content=escapeHTML(n.content.trim().replace(l,"")),n.content=wrapLinksInAnchorTags(n.content);let p=q("#inputFile");if(console.dir(p.files),p.files.length>0)try{let u=await cryptoFiles(p.files);n.files=u}catch(f){throw cl({"catch в форме во время шифровании файлов":f}),f}jsonara.data[id]=n,n.tags.forEach(function(t){!jsonara.tags[t]&&(jsonara.tags[t]=[],q(".menu").insertAdjacentHTML("afterbegin",`<li>${t}</li>`),q(".menu").clientHeight<q(".menu").scrollHeight&&q(".menu").insertAdjacentHTML("afterend",`<a class="showtags" onclick="showtags(this)">все теги</a>`)),jsonara.tags[t].push(id)}),cl({"Массив с данными подготовлен":jsonara});let g=await encrypt(JSON.stringify(jsonara));updategit(g).then(a=>(cl(`Данные успешно добавлены`),t.target.reset(),p.onchange(),viewContent([n],2))).catch(t=>{throw cl({"catch в форме во время updategit":t}),t})}catch(y){alert(`Ошибка при сохранении. ${y}`),cl({"catch в конце формы":y})}}),q("#auth").addEventListener("submit",async function(t){t.preventDefault(),decrypt(encryptdb,password=t.target.elements.password.value).then(t=>{jsonara=JSON.parse(t),qq(".ifauth").forEach(function(t){t.classList.remove("ifauth")}),Object.keys(jsonara.tags).forEach(t=>{q(".menu").insertAdjacentHTML("afterbegin",`<li>${t}</li>`)}),q(".menu").clientHeight<q(".menu").scrollHeight&&q(".menu").insertAdjacentHTML("afterend",`<a class="showtags" onclick="showtags()">все теги</a>`),jsonara.data.reverse(),viewContent(jsonara.data),jsonara.data.reverse(),q("#auth").classList.add("none"),token=jsonara.token,cl({"Успешная авторизация":jsonara})}).catch(t=>{cl({"Catch в #auth":t}),alert("Неверный пароль")})}),q(".addbtn").addEventListener("click",t=>q("#dataSave").classList.toggle("none"));let psdiv=q(".progress");function loadanim(t=!1){!1!==t?(psdiv.style.top="0px",psdiv.style.width=t+"%"):psdiv.style.top="-5px"}function showtags(){q(".menu").style.height="auto",q(".wrapcont").removeChild(q(".showtags"))}async function encrypt(t,a=password){try{let n=(new TextEncoder).encode(t),s=crypto.getRandomValues(new Uint8Array(12)),i=crypto.getRandomValues(new Uint8Array(16)),r=await genAES(a,i),l=await crypto.subtle.encrypt({name:"AES-GCM",iv:s},r,n),o=new Uint8Array(28+l.byteLength);return o.set(i),o.set(s,16),o.set(new Uint8Array(l),28),btoa(String.fromCharCode(...o))}catch(c){throw cl({"Catch в encrypt":c}),c}}async function decrypt(t,a=password){try{let n=new Uint8Array(atob(t).split("").map(t=>t.charCodeAt(0))),s=n.slice(0,16),i=n.slice(16,28),r=n.slice(28),l=await genAES(a,s),o=await crypto.subtle.decrypt({name:"AES-GCM",iv:i},l,r);return(new TextDecoder).decode(o)}catch(c){throw cl({"catch в decrypt":c}),c}}async function genAES(t,a){let n=(new TextEncoder).encode(t),s=await crypto.subtle.importKey("raw",n,"PBKDF2",!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:a,iterations:1,hash:"SHA-256"},s,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}const limitCryptoApi=async t=>{cl(t),cl("Проверка максимального размера файла");let a=1e5,n=0;try{if(loadanim(20),t<1e6)try{return await encrypt("a".repeat(t)),loadanim(40),cl(`Размер файла, меньше максимального`),t}catch(s){cl({"catch в limitCryptoApi 1":s}),loadanim(50)}for(loadanim(60);;){a+=1e4;await encrypt("a".repeat(a)),n=a}}catch(i){return loadanim(70),cl({"catch в limitCryptoApi 2":i,"Максимальный размер":n}),n}};function base2file(t,a){let n=a.split(","),s=n[0].split(":")[1],i=n[1],r=atob(i),l=new Uint8Array(r.length);for(let o=0;o<r.length;o++)l[o]=r.charCodeAt(o);let c=new Blob([l],{type:s}),d=new File([c],t,{type:s}),h=document.createElement("a");h.href=URL.createObjectURL(d),h.download=d.name,document.body.appendChild(h),h.click(),document.body.removeChild(h)}
</script>